// MIDI Training App - Security-Focused Database Schema
// Designed with security best practices, OWASP compliance, and GDPR considerations

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// USERS & AUTHENTICATION
// ============================================================================

model User {
  id                String    @id @default(cuid())
  
  // Core Authentication Fields
  email             String    @unique @db.VarChar(255)
  emailVerified     DateTime? @map("email_verified")
  password          String?   @db.VarChar(255) // Nullable for OAuth-only users
  
  // Profile Information  
  name              String?   @db.VarChar(100)
  image             String?   @db.VarChar(500)
  
  // Authorization & Access Control
  role              UserRole  @default(FREE)
  
  // Security & Account Protection
  loginAttempts     Int       @default(0) @map("login_attempts")
  lockedUntil       DateTime? @map("locked_until")
  lastLoginAt       DateTime? @map("last_login_at")
  lastLoginIp       String?   @map("last_login_ip") @db.Inet
  passwordChangedAt DateTime? @map("password_changed_at")
  
  // Two-Factor Authentication
  twoFactorEnabled  Boolean   @default(false) @map("two_factor_enabled")
  twoFactorSecret   String?   @map("two_factor_secret") @db.VarChar(255)
  backupCodes       String[]  @map("backup_codes")
  
  // Privacy & GDPR Compliance
  termsAcceptedAt   DateTime? @map("terms_accepted_at")
  privacyAcceptedAt DateTime? @map("privacy_accepted_at")
  marketingOptIn    Boolean   @default(false) @map("marketing_opt_in")
  dataProcessingConsent Boolean @default(false) @map("data_processing_consent")
  
  // Account Lifecycle
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  deletedAt         DateTime? @map("deleted_at") // Soft delete for GDPR
  
  // Relations
  accounts          Account[]
  sessions          Session[]
  auditLogs         AuditLog[]
  practiceProgress  PracticeProgress[]
  subscription      Subscription?
  
  // Database optimizations
  @@index([email])
  @@index([createdAt])
  @@index([lastLoginAt])
  @@index([deletedAt])
  @@index([lockedUntil])
  @@map("users")
}

// OAuth Account Management (Google, Facebook, etc.)
model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String  @db.VarChar(50)
  provider          String  @db.VarChar(50)
  providerAccountId String  @map("provider_account_id") @db.VarChar(255)
  
  // OAuth Tokens (encrypted at rest)
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String? @db.VarChar(50)
  scope             String? @db.Text
  id_token          String? @db.Text
  session_state     String? @db.Text
  
  // Security tracking
  createdAt         DateTime @default(now()) @map("created_at")
  lastUsedAt        DateTime @default(now()) @map("last_used_at")
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([provider, providerAccountId])
  @@index([userId])
  @@index([provider])
  @@map("accounts")
}

// Session Management for Authentication
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token") @db.VarChar(255)
  userId       String   @map("user_id")
  expires      DateTime
  
  // Security tracking
  ipAddress    String?  @map("ip_address") @db.Inet
  userAgent    String?  @map("user_agent") @db.VarChar(500)
  deviceInfo   Json?    @map("device_info") // Browser, OS, device type
  
  // Session metadata
  createdAt    DateTime @default(now()) @map("created_at")
  lastActivity DateTime @default(now()) @map("last_activity")
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([expires])
  @@index([sessionToken])
  @@index([lastActivity])
  @@map("sessions")
}

// Email verification and password reset tokens
model VerificationToken {
  id         String   @id @default(cuid())
  identifier String   @db.VarChar(255) // email or user ID
  token      String   @unique @db.VarChar(255)
  type       TokenType @default(EMAIL_VERIFICATION)
  expires    DateTime
  attempts   Int      @default(0) // Prevent brute force
  
  // Security tracking
  createdAt  DateTime @default(now()) @map("created_at")
  usedAt     DateTime? @map("used_at")
  ipAddress  String?  @map("ip_address") @db.Inet
  
  @@unique([identifier, token])
  @@index([expires])
  @@index([type])
  @@map("verification_tokens")
}

// ============================================================================
// SECURITY & AUDIT LOGGING
// ============================================================================

model AuditLog {
  id        String   @id @default(cuid())
  
  // Who performed the action
  userId    String?  @map("user_id")
  
  // What happened
  action    AuditAction
  entity    String?  @db.VarChar(100) // "User", "Session", "Subscription"
  entityId  String?  @map("entity_id")
  
  // Context and metadata
  metadata  Json?    // Additional context (old/new values, etc.)
  
  // Security context
  ipAddress String?  @map("ip_address") @db.Inet
  userAgent String?  @map("user_agent") @db.VarChar(500)
  
  // Compliance
  severity  LogSeverity @default(INFO)
  category  String   @db.VarChar(50) // "auth", "data", "security"
  
  // Timing
  createdAt DateTime @default(now()) @map("created_at")
  
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@index([severity])
  @@index([ipAddress])
  @@map("audit_logs")
}

// ============================================================================
// APPLICATION DATA
// ============================================================================

// User practice progress and statistics
model PracticeProgress {
  id              String   @id @default(cuid())
  userId          String   @map("user_id")
  
  // Progress tracking
  moduleType      String   @map("module_type") @db.VarChar(50) // "chord-recognition", "counterpoint"
  levelId         String   @map("level_id") @db.VarChar(100)
  
  // Performance metrics
  score           Int      // 0-100
  timeSpent       Int      @map("time_spent") // seconds
  attempts        Int      @default(1)
  
  // Detailed stats
  correctAnswers  Int      @map("correct_answers")
  totalQuestions  Int      @map("total_questions")
  averageTime     Float    @map("average_time") // seconds per question
  
  // Metadata
  difficulty      String   @db.VarChar(20) // "beginner", "intermediate", "advanced"
  completedAt     DateTime @map("completed_at")
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId, moduleType, levelId, completedAt])
  @@index([userId])
  @@index([moduleType])
  @@index([completedAt])
  @@map("practice_progress")
}

// Subscription and billing (for future paywall)
model Subscription {
  id               String           @id @default(cuid())
  userId           String           @unique @map("user_id")
  
  // Subscription details
  plan             SubscriptionPlan
  status           SubscriptionStatus
  
  // Billing
  stripeCustomerId String?          @unique @map("stripe_customer_id")
  stripeSubscriptionId String?      @unique @map("stripe_subscription_id")
  
  // Subscription lifecycle
  startDate        DateTime         @map("start_date")
  endDate          DateTime?        @map("end_date")
  trialEndsAt      DateTime?        @map("trial_ends_at")
  cancelledAt      DateTime?        @map("cancelled_at")
  
  // Metadata
  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @updatedAt @map("updated_at")
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([status])
  @@index([endDate])
  @@map("subscriptions")
}

// ============================================================================
// ENUMS & TYPES
// ============================================================================

enum UserRole {
  FREE
  PREMIUM
  PRO
  TEACHER
  ADMIN
  
  @@map("user_role")
}

enum TokenType {
  EMAIL_VERIFICATION
  PASSWORD_RESET
  TWO_FACTOR_RECOVERY
  
  @@map("token_type")
}

enum AuditAction {
  // Authentication
  USER_REGISTERED
  USER_LOGIN
  USER_LOGOUT
  USER_LOGIN_FAILED
  PASSWORD_CHANGED
  EMAIL_VERIFIED
  ACCOUNT_LOCKED
  TWO_FACTOR_ENABLED
  TWO_FACTOR_DISABLED
  
  // Data operations
  USER_UPDATED
  USER_DELETED
  PROGRESS_RECORDED
  
  // Security events
  SUSPICIOUS_ACTIVITY
  SECURITY_ALERT
  
  // Subscription
  SUBSCRIPTION_CREATED
  SUBSCRIPTION_UPDATED
  SUBSCRIPTION_CANCELLED
  
  @@map("audit_action")
}

enum LogSeverity {
  DEBUG
  INFO
  WARN
  ERROR
  CRITICAL
  
  @@map("log_severity")
}

enum SubscriptionPlan {
  FREE
  PREMIUM
  PRO
  TEACHER
  
  @@map("subscription_plan")
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELLED
  INCOMPLETE
  TRIAL
  
  @@map("subscription_status")
}
